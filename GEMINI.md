# GEMINI.md — 完全自律で「Windows/Mac 両対応」アプリを完成させるための指示書

> **目的**: 本プロジェクトの既存コードと仕様を読み取り、**人手の操作（承認/質問/待機）を極力ゼロ**で、設計 → 実装 → テスト → バグ修正 → パッケージ化（Win: EXE/MSI, macOS: DMG/ZIP）まで**自律的に完遂**すること。
>
> **対象アプリ**: 「アダアフィ用ショート動画支援アプリ（仮）」：
>
> * 機能A: **XのRT監視 → スクショ → 背景動画合成 → ショート動画自動生成/保存**
> * 機能B: **TikTok/Instagram/YouTube のショート監視 → 転載向けフォーマットへ変換/保存**
> * UI: ダッシュボード（監視状況と開始/設定ボタン）、設定（監視対象/間隔、動画出力：解像度・長さ・BGM・背景・上/下テロップ）

---

## 0. 自律実行ポリシー（最重要）

**絶対に守るルール**

* 起動は常に `--yolo --checkpointing`。破壊的変更の**直前にスナップショット**→ 失敗時は**自動ロールバック**（最新スナップショットを復元）して続行する。
* **確認ダイアログ禁止**。不明点は合理的仮定で進め、ログに意思決定を記録する。
* **計画 → 実装 → テスト → 修正**の短サイクルを**自動反復**。テスト失敗は**自動修正して再実行**。
* 連続失敗 3 回で**計画を再立案**。10 回で**スコープ縮小（ユニット中心）**→ それでも不可なら**直前スナップショットへ復元**。
* 危険コマンド（例：`rm -rf /`、レジストリ改変、グローバル `npm -g`、管理者権限の恒久変更）は**禁止**。代替手段で継続。
* 429/403/ネットワーク断は**指数バックオフ**（例：2s, 4s, 8s… 最大 5 分）＋上限リトライ。タイムアウト/回線断は**待機モード**へ移行し、回復後に再開。
* ログは**JSON Lines + 人間向けUIログ**の二系統。
* すべての**チャット**（エージェント応答・計画出力・エラーメッセージ）およびREADME/ログ説明は**日本語**で行う。コード/設定名などの固有名詞は英語可。

---

## 1. Definition of Done（完了基準）

1. **Windows 10/11 と macOS（Intel/Apple Silicon）で起動・動作**。
2. ダッシュボードから**監視開始/停止**が可能で、**設定の変更がリアルタイム反映**される。
3. 機能A/B の**監視→処理→保存**が連続ジョブとして安定稼働（並列数/リトライ/最大実行時間/ローテーション管理）。
4. **動画出力**は指定のスキーマ（解像度/比率/長さ/BGM/背景/テロップ）を満たし、**80%スケール & 黒背景のテロップ領域**に正しく合成される。
5. **ユニット/統合/E2E**の全テストが**ローカル & CI**で成功。
6. パッケージ成果物：

   * **Windows**: `dist/win/*.exe` と（可能なら）`*.msi`
   * **macOS**: `dist/mac/*.dmg`（または `*.zip`）
7. **README** に「動作要件/初回起動/未署名アプリの開き方（Gatekeeper回避）」を自動追記。
8. 重大エラーは OS 通知（Toast/NSUserNotification）または Webhook 通知が飛ぶ。

---

## 2. 環境・依存の固定と導入

* **Node.js**、**パッケージマネージャ（npm/pnpm）**、**Python（任意）**、**ffmpeg** を**バージョン固定**し、存在チェック → 未導入なら**自動導入**。

  * Windows: `winget` または `choco` で ffmpeg を導入。実行前に **UTF-8** を保証（`chcp 65001`）。
  * macOS: `brew install ffmpeg`。必要に応じて `xcode-select --install`。
* `.nvmrc` / `.tool-versions` / `package-lock.json` で固定。CI でも同バージョンを使用。
* GUI は **Electron + React + TypeScript + Vite**（想定）。UI は `shadcn/ui` を利用。
* スクレイピング/自動化は**合法とプラットフォーム規約を尊重**し、**レート制限**と**バックオフ**を必ず実装。

---

## 3. シークレット/ログイン/プライバシー

* ログイン情報は**平文保存禁止**：

  * Windows: **DPAPI / Credential Manager**
  * macOS: **Keychain**
* 2FA 等が必要になった場合は、**一時モーダル**で入力を受け取り安全ストアへ保存し、処理を自動再開。
* ログは**個人情報をマスク**し、エラーレポートに含めない。

---

## 4. 仕様（機能A/B、UI、ジョブ管理）

### 4.1 監視対象・ログイン

* 対応プラットフォーム：X / TikTok / Instagram / YouTube
* 監視対象アカウントは**複数**指定可。\*\*監視間隔（分）\*\*を個別に設定。
* **ログインボタン**（各プラットフォーム）と**状態表示**を設定画面に用意。状態はアプリ全体のストアで共有。

### 4.2 動画生成・変換

* 共通スキーマ（JSON）で設定を管理：

```json
{
  "resolution": {"width": 1080, "height": 1920},
  "durationSec": 15,
  "bgmPath": "",
  "backgroundVideoPath": "",
  "captions": {"top": "", "bottom": ""},
  "scale": 0.8,
  "teleTextBg": "#000000"
}
```

* **ffmpeg コマンドは自動生成**（映像フィルタ：`scale`, `pad`, `drawtext`/字幕、`acompressor`/`volume`）。
* 失敗時は\*\*中間生成物（スクショ/一時動画）\*\*を保存してデバッグ可能に。

### 4.3 UI（React 想定）

**GUIは既存コードをベースに実装する（再生成や大規模な置換は禁止）**:

* 既存のコンポーネント/スタイル/ディレクトリ構造を尊重し、**差分実装**（イベント配線・不足機能の追加・軽微な修正）のみに留める。

* フレームワーク切替や破壊的リファクタは原則禁止。必要な場合は最小差分パッチと移行理由をログに記録。

* 既存の状態管理/ルーティングを踏襲。新規ストアが必要な場合は**互換アダプタ**層を挟む。

* 既存UIと仕様が不整合な場合は\*\*変更点一覧（PRスタイル）\*\*を出力し、合意前提で最小変更で対応。

* **ダッシュボード**:

  * 機能A/Bの**概要カード**（監視対象/間隔/出力の要約）と「監視を開始」「設定を開く」。
  * 右側に**ログコンソール**（レベル別フィルタ・検索）を配置。長時間稼働向けに**ローテーション**実装。

* **設定画面**:

  * 「監視用アカウント設定」「動画出力設定」の 2 セクション。
  * 各セクションの値は**単一ストア**に保存し、ダッシュボードへ双方向反映。

### 4.4 ジョブ管理

* **ジョブマネージャ**を実装：並列数、キュー、最大再試行、最大実行時間、指数バックオフ、強制中断、クラッシュ後の自動再開。
* **停止条件**：連続エラー 10 回、総処理 100 件/1h 超、到達不能 15 分保持で**安全停止**＋レポート出力。

---

## 5. 設計ガイド（推奨アーキテクチャ）

* Electron **Main**: プロセス管理/OS権限/通知。
* **Preload**: セキュアな IPC ブリッジ。
* **Renderer(React)**: UI・設定・ログ可視化。
* **Node ワーカー/子プロセス**: 監視・ダウンロード・ffmpeg 実行。CPU/GPU 競合を避け、**キュー制御**。

---

## 6. テスト戦略（自動修復ループ対応）

* **Unit**: 設定バリデーション、ffmpeg 引数生成、スケジューラ/バックオフ。
* **Integration**: スクショ→合成の**短尺クリップ**で**ゴールデン比較**（フレームハッシュ/メタ情報）。
* **E2E（Playwright）**: 設定保存→監視開始→ログ検証（ヘッドレス）。
* `npm test` で三層を順実行。失敗時は**原因分析→自動修正→再試行**を 3 周期まで繰返す。

---

## 7. CI/CD

* **GitHub Actions**（任意）で Node/ffmpeg をセットアップし、`npm ci && npm test && npm run build`。
* 成果物（EXE/MSI/DMG/ZIP）を **Artifacts** として保存。サイズ大きい場合は**分割**。

---

## 8. パッケージング（配布）

* **electron-builder** などで**Win/Mac 両対応**。
* **アイコン**/アプリ名/バージョン埋め込み。
* 署名は任意。未署名の場合は README へ**Gatekeeper 回避手順**を生成して追記：

  * macOS: 右クリック→開く or `xattr -d com.apple.quarantine <App>`
  * Windows: スマートスクリーンの回避手順を記載。

---

## 9. 運用・監視・通知

* JSON Lines ログを**永続化**。UI はストリームで表示し、**検索/レベルフィルタ**対応。
* 重大エラー時：OS 通知 or Webhook（Discord/Slack/メール）。
* ログ肥大化はローテーション（サイズ閾値/日次）。

---

## 10. 実行シナリオ（エージェントの行動計画）

1. **ワークスペース読取** → 既存コード/この GEMINI.md/README を解析し、**実行計画（箇条書き）を出力**（※GUIは既存コードを**再利用**し、再生成はしない。イベント配線と不足部の実装に限定）。
2. **環境点検** → Node/ffmpeg/ビルドツールを検出。無ければ**自動導入**。（Win: winget/choco、Mac: brew）
3. **設定スキーマ/ストア実装** → 既存GUIコンポーネントを**流用**してUIと連携。ダッシュボードの要約表示を完成。
4. **ジョブマネージャ** 実装 → 並列/再試行/停止条件/バックオフを実装。
5. **機能A/B** を実装：

   * ログイン（安全ストア保存）→ 監視 → 取得/スクショ/変換 → ffmpeg 合成 → 保存。
   * テンプレ合成（80%スケール・黒背景テロップ領域）。
6. **テスト** 作成 → `npm test` 実行 → 失敗を自動修正（最大3回反復）。
7. **ビルド** → `npm run build`。Win/Mac の成果物生成。
8. **README 追記**（環境要件・初回起動・未署名アプリの開き方・基本の使い方）。
9. **最終自己チェック**：DoD 満たすか検証。満たさない場合は不足分を実装して再テスト/再ビルド。

---

## 11. コマンド/実行例（参考）

* 起動: `gemini --yolo --checkpointing`
* 例: 「**このGEMINI.mdに従って、Windows/Mac 両方の実行ファイルまで完全自動で作成。全テスト成功させ、成果物とログを提示。**」

---

## 12. エラー/例外ハンドリング規約

* 例外は**原因/対処/再発防止**の 3 点でログ化（機械可読 + 人間可読）。
* ネットワーク/レート制限：指数バックオフ、プロキシ切替（存在すれば）、ジョブ中断→再開。
* 永続化失敗：一時フォルダへフォールバックし、ユーザーに**保存先の再設定**を提案（UI）。

---

## 13. 品質・スタイル・国際化

* コードスタイルは ESLint/Prettier。コミットは Conventional Commits。
* **チャットは常に日本語**。UI文言は i18n 対応（**日本語が既定**、英語はオプション）。
* タイムゾーンは既定で **Asia/Tokyo** を使用（スケジューリング/ログに反映）。

---

## 14. セキュリティ/法令・規約順守

* 利用規約/ロボッツ/著作権/プラットフォーム規約を尊重。必要に応じて**明示的な待機/上限**を設定。
* 外部送信するデータを最小化。機微情報は含めない。

---

## 15. 付録：動画生成の ffmpeg 方針（例）

* 例：1080x1920, 15 秒, 80% スケール、上下テロップ、BGM 合成

```
ffmpeg -y \
  -i <background.mp4> -i <screenshot.png> -i <bgm.mp3> \
  -filter_complex "[1:v]scale=iw*0.8:-1[fg]; \
                   [0:v]scale=1080:1920,format=yuv420p[bg]; \
                   [bg][fg]overlay=(W-w)/2:(H-h)/2, \
                   drawbox=x=0:y=0:w=iw:h=120:color=black@1.0:t=fill, \
                   drawtext=text='${TOP}':x=(w-text_w)/2:y=30:fontcolor=white:fontsize=48, \
                   drawbox=x=0:y=h-160:w=iw:h=160:color=black@1.0:t=fill, \
                   drawtext=text='${BOTTOM}':x=(w-text_w)/2:y=h-130:fontcolor=white:fontsize=42" \
  -map 0:a -map 2:a -filter:a:1 volume=0.6 -shortest -t 15 \
  -c:v libx264 -preset veryfast -pix_fmt yuv420p -c:a aac out.mp4
```

> 実際は設定 JSON から**安全に**引数を生成し、**エスケープ**を厳格に行うこと。

##アプリの説明
このアプリケーションは「アダアフィ用ショート動画支援アプリ（仮）」という名称のデスクトップツールです。主な目的は、設定したSNSアカウントを監視し、その内容から自動でショート動画を生成・変換して保存することです。

主な機能
このアプリには、大きく分けて2つの主要な機能があります。

XアカウントのRTから動画を自動生成

設定したXアカウントがRT（リポスト）した投稿をスクリーンショットで取得し、それを背景動画と合成して自動でショート動画を生成・保存します。

監視対象となるXアカウントは複数指定できます。

ショート動画の転載変換

TikTok、Instagram、YouTubeのショート動画アカウントの内容を監視し、転載に適した形式の動画として自動で保存します。

各プラットフォームで監視対象のアカウントを複数指定可能です。

カスタマイズ可能な設定項目
ユーザーは、生成する動画の仕様や監視方法を細かく設定できます。

監視アカウント設定:

監視対象: X、TikTok、Instagram、YouTubeのユーザーアカウントを複数指定できます。

監視間隔: 各プラットフォームの監視間隔を分単位で設定できます。

ログイン: 監視のためにX、YouTube、TikTok、Instagramのアカウントにログインする機能があります。

動画出力設定:

解像度: 生成する動画の幅（Width）と高さ（Height）を指定できます。

動画の長さ: 動画の長さを秒単位で設定できます。

BGM: 任意のBGMファイルを動画に追加できます。

背景動画: 任意の動画を背景として設定できます。

テロップ: 動画の上部と下部に任意のテキストテロップを挿入できます。

ユーザーインターフェース
ダッシュボード: 各機能の監視状況（監視対象、間隔、出力設定など）を一覧で確認し、「監視を開始」ボタンで操作できます。

動作状況ログ: アプリケーションの動作状況がリアルタイムで表示されるログ機能があり、問題の把握に役立ちます。

---

### 最後に

この指示書は「**人手ゼロで走り切る**」ための手順・安全柵・完成基準を包含しています。ここに記したルールと順序で、**計画→実装→テスト→ビルド**を **自律反復**し、DoD の達成をもって終了してください。
